

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Training &mdash; Cellfinder  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Troubleshooting" href="troubleshooting.html" />
    <link rel="prev" title="Usage" href="run.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Cellfinder
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="run.html">Usage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Training</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#generate-training-data">Generate training data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#arguments">Arguments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#start-training">Start training</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Arguments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#further-help">Further help</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tools/cell_view_2D.html">Two dimensional cell viewer</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools/cell_view_3D.html">Three dimensional viewer</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools/cells_standard_space.html">Transforming cells into standard space</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools/count_summary.html">Organise cells into atlas regions</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools/region_summary.html">Summarise cell counts from multiple brains</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools/xml_crop.html">XML file cropping</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools/xml_scale.html">XML file rescaling</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about/release_notes.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about/roadmap.html">Future Plans</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev/CONTRIBUTING.html">Contributing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="misc/hpc.html">Cellfinder installation in a cluster computing environment.</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cellfinder</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Training</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="training">
<h1>Training<a class="headerlink" href="#training" title="Permalink to this headline">¶</a></h1>
<p>Cellfinder includes a pretrained network for cell candidate classification.
This will likely need to be retrained for different applications. Rather than
generate training data blindly, the aim is to reduce the amount of hands-on
time by only generating training data where cellfinder classified a cell
candidiate incorrectly.</p>
<div class="section" id="generate-training-data">
<h2>Generate training data<a class="headerlink" href="#generate-training-data" title="Permalink to this headline">¶</a></h2>
<p>To generate training data, you will need:</p>
<ul class="simple">
<li><p>The cellfinder output file, <code class="docutils literal notranslate"><span class="pre">cell_classification.xml</span></code> (but <code class="docutils literal notranslate"><span class="pre">cells.xml</span></code>
can also work).</p></li>
<li><p>The raw data used initially for cellfinder</p></li>
</ul>
<p>To generate training data for a single brain, use <code class="docutils literal notranslate"><span class="pre">cellfinder_curate</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cellfinder_curate signal_images background_images cell_classification.xml
</pre></div>
</div>
<div class="section" id="arguments">
<h3>Arguments<a class="headerlink" href="#arguments" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Signal images</p></li>
<li><p>Background images</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cell_classification.xml</span></code> file</p></li>
</ul>
<p><strong>Either</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-x</span></code> or <code class="docutils literal notranslate"><span class="pre">--x-pixel-um</span></code> Pixel spacing of the data in the first dimension,
specified in um.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-y</span></code> or <code class="docutils literal notranslate"><span class="pre">--y-pixel-um</span></code> Pixel spacing of the data in the second dimension,
specified in um.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-z</span></code> or <code class="docutils literal notranslate"><span class="pre">--z-pixel-um</span></code> Pixel spacing of the data in the third dimension,
specified in um.</p></li>
</ul>
<p><strong>Or</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--metadata</span></code> Metadata file containing pixel sizes (any format supported
by <a class="reference external" href="https://github.com/adamltyson/micrometa">micrometa</a> can be used).
If both pixel sizes and metadata are provided, the command line arguments
will take priority.</p></li>
</ul>
<p><strong>Optional</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-o</span></code> or <code class="docutils literal notranslate"><span class="pre">--output</span></code> Output directory for curation results. If this is not
given, then the directory containing <code class="docutils literal notranslate"><span class="pre">cell_classification.xml</span></code> will be used.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--symbol</span></code> Marker symbol (Default: <code class="docutils literal notranslate"><span class="pre">ring</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--marker-size</span></code> Marker size(Default: <code class="docutils literal notranslate"><span class="pre">15</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--opacity</span></code> Marker opacity (Default: <code class="docutils literal notranslate"><span class="pre">0.6</span></code>)</p></li>
</ul>
<p>A <a class="reference external" href="https://napari.org/">napari</a> window will then open, showing two tabs on the
left hand side:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Image</span></code> Selecting this allows you to change the contrast limits, to better
visualise cells</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Cell</span> <span class="pre">candidates</span></code> This shows the cell candidates than be curated. Cell
candidates previously classified as cells are shown in yellow, and artifacts
in blue.</p></li>
</ul>
<p>By selecting the <code class="docutils literal notranslate"><span class="pre">Cell</span> <span class="pre">candidates</span></code> tab and then the cell selecting tool
(arrow at the top), cell candidates can be selected (either individually,
or many by dragging the cursor). There are then four keyboard commands:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">C</span></code> Confirm the classification result, and add this to the training set</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">T</span></code> Toggle the classification result (i.e. change the classification),
and add this to the training set.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Ctrl+S</span></code> Save the results to an xml file</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Alt+E</span></code> Finish training. This will carry out three operations:</p>
<ul>
<li><p>Extract cubes around these points, into two directories (<code class="docutils literal notranslate"><span class="pre">cells</span></code> and
<code class="docutils literal notranslate"><span class="pre">non_cells</span></code>).</p></li>
<li><p>Generate a yaml file pointing to these files for use with
<code class="docutils literal notranslate"><span class="pre">cellfinder_train</span></code> (see below)</p></li>
<li><p>Close the viewer</p></li>
</ul>
</li>
</ul>
<p>Once a yaml file has been generated, you can proceed to training. However, it
is likely useful to generate yaml files from additional datasets.</p>
</div>
</div>
<div class="section" id="start-training">
<h2>Start training<a class="headerlink" href="#start-training" title="Permalink to this headline">¶</a></h2>
<p>You can then use these yaml files for training</p>
<p><em>N.B. If you have any yaml files from previous versions of cellfinder, they
will continue to work, but are not documented here. Just use them as
you would the files from <code class="docutils literal notranslate"><span class="pre">cellfinder_curate</span></code>.</em></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cellfinder_train -y yaml_1.yml  yaml_2.yml -o /path/to/output/directory/
</pre></div>
</div>
<div class="section" id="id1">
<h3>Arguments<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-y</span></code> or <code class="docutils literal notranslate"><span class="pre">--yaml</span></code> The path to the yaml files defining training data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-o</span></code> or <code class="docutils literal notranslate"><span class="pre">--output</span></code> Output directory for the trained model (or model weights)
results</p></li>
</ul>
<p><strong>Optional</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--continue-training</span></code> Continue training from an existing trained model.
If no model or model weights are specified, this will continue from the
included model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--trained-model</span></code> Path to a trained model to continue training</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--model-weights</span></code> Path to existing model weights to continue training</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--network-depth</span></code> Resnet depth
(based on <a class="reference external" href="https://arxiv.org/abs/1512.03385">He et al. (2015)</a>). Choose from
(18, 34, 50, 101 or 152). In theory, a deeper network should classify better,
at the expense of a larger model, and longer training time. Default: 50</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--batch-size</span></code> Batch size for training (how many cell candidates to process
at once). Default: 16</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--epochs</span></code> How many times to use each sample for training. Default: 1000</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--test-fraction</span></code> What fraction of data to keep for validation. Default: 0.1</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--learning-rate</span></code> Learning rate for training the model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--no-augment</span></code> Do not use data augmentation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--save-weights</span></code> Only store the model weights, and not the full model.
Useful to save storage space.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--save-checkpoints</span></code> Store the model at intermediate points during training</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--checkpoint-interval</span></code> Number of epochs between checkpoints</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--tensorboard</span></code> Log to <code class="docutils literal notranslate"><span class="pre">output_directory/tensorboard</span></code>. Use
<code class="docutils literal notranslate"><span class="pre">tensorboard</span> <span class="pre">--logdir</span> <span class="pre">outputdirectory/tensorboard</span></code> to view.</p></li>
</ul>
</div>
<div class="section" id="further-help">
<h3>Further help<a class="headerlink" href="#further-help" title="Permalink to this headline">¶</a></h3>
<p>All cellfinder_train options can be found by using the <code class="docutils literal notranslate"><span class="pre">-h</span></code> flag</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cellfinder_train -h
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="troubleshooting.html" class="btn btn-neutral float-right" title="Troubleshooting" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="run.html" class="btn btn-neutral float-left" title="Usage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Sainsbury Wellcome Centre

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>